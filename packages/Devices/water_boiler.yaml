switcher_kis:
  phone_id: !secret switcher_phone_id
  device_id: !secret switcher_device_id
  device_password: !secret switcher_device_password

input_datetime:
  water_boiler_last_on:
    has_date: true
    has_time: true
  water_boiler_last_off:
    has_date: true
    has_time: true

automation:
  - id: Save Water Boiler On Off Time
    alias: Save Water Boiler On Off Time
    trigger:
      - platform: state
        entity_id: switch.water_boiler
        from: "on"
        to: "off"
      - platform: state
        entity_id: switch.water_boiler
        from: "off"
        to: "on"
    action:
      service: input_datetime.set_datetime
      data:
        entity_id: "input_datetime.water_boiler_last_{{ trigger.to_state.state }}"
        datetime: "{{ now() }}"

sensor:
  - platform: history_stats
    name: Water Boiler Metrics Duration Today
    entity_id: switch.water_boiler
    state: "on"
    type: time
    start: "{{ now().replace(hour=0, minute=0, second=0) }}"
    end: "{{ now() }}"


template:
  - sensor:
      - name: "Water Boiler Metrics Duration Last Time"
        state: >
          {% if is_state('switch.water_boiler', 'on') %}
          {{ as_datetime(as_timestamp(now()) - state_attr('input_datetime.water_boiler_last_on', 'timestamp')).strftime('%-Hh %-Mm') | replace('0h ', '') | replace('0m', '') }}
          {% else %}
          {{ as_datetime(state_attr('input_datetime.water_boiler_last_off', 'timestamp') - state_attr('input_datetime.water_boiler_last_on', 'timestamp')).strftime('%-Hh %-Mm')  | replace('0h ', '') | replace(' 0m', '') }}
          {% endif %}

      - name: "Water Boiler Metrics Time Since Finished"
        state: "{{ as_datetime(as_timestamp(now()) - state_attr('input_datetime.water_boiler_last_off', 'timestamp')).strftime('%-dd %-Hh %-Mm') | replace('0h ', '') | replace('0m', '') }}"

  - binary_sensor:
      - name: "Water Boiler Was On Today"
        state: "{{ not states('sensor.water_boiler_metrics_time_since_finished') | string is match('^\\dd') }}"
